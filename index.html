<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Inventario y Ventas (Local)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@0.378.0/dist/umd/lucide.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-button.active { border-color: #3b82f6; color: #3b82f6; background-color: #eff6ff; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .low-stock { background-color: #fef9c3 !important; color: #713f12; }
        .out-of-stock { background-color: #fee2e2 !important; color: #991b1b; }
        .in-stock { background-color: #dcfce7 !important; color: #166534; }
        #qr-reader { width: 100%; max-width: 500px; border: 1px solid #ccc; }
        #qr-reader__dashboard_section_csr button { background-color: #ef4444; color: white; padding: 8px; border-radius: 5px; margin-top: 10px;}
        .product-search-results { max-height: 200px; overflow-y: auto; border: 1px solid #ccc; }
        .product-search-item:hover { background-color: #f0f0f0; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="container mx-auto p-4">
        <header class="bg-blue-600 text-white p-6 rounded-lg shadow-lg mb-6">
            <h1 class="text-3xl font-bold">Sistema de Control de Inventario y Ventas (Local)</h1>
            <p class="text-sm">Usuario: <span id="userIdDisplay" class="font-mono">Usuario Local</span></p>
        </header>

        <div class="mb-6 flex space-x-2 border-b border-gray-300">
            <button class="tab-button py-2 px-4 font-semibold border-b-2 border-transparent hover:border-blue-500 hover:text-blue-500 focus:outline-none active" data-tab="dashboard">
                <i data-lucide="layout-dashboard" class="inline-block mr-2"></i>Dashboard
            </button>
            <button class="tab-button py-2 px-4 font-semibold border-b-2 border-transparent hover:border-blue-500 hover:text-blue-500 focus:outline-none" data-tab="inventory">
                <i data-lucide="package" class="inline-block mr-2"></i>Inventario
            </button>
            <button class="tab-button py-2 px-4 font-semibold border-b-2 border-transparent hover:border-blue-500 hover:text-blue-500 focus:outline-none" data-tab="sales">
                <i data-lucide="shopping-cart" class="inline-block mr-2"></i>Ventas
            </button>
            <button class="tab-button py-2 px-4 font-semibold border-b-2 border-transparent hover:border-blue-500 hover:text-blue-500 focus:outline-none" data-tab="stores">
                <i data-lucide="store" class="inline-block mr-2"></i>Tiendas
            </button>
            <button class="tab-button py-2 px-4 font-semibold border-b-2 border-transparent hover:border-blue-500 hover:text-blue-500 focus:outline-none" data-tab="importExport">
                <i data-lucide="file-up" class="inline-block mr-2"></i>Importar/Exportar
            </button>
        </div>

        <main id="tab-content">
            <div id="dashboard-content" class="tab-pane active p-4 bg-white rounded-lg shadow">
                <h2 class="text-2xl font-semibold mb-4">Resumen Financiero</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-green-100 p-4 rounded-lg shadow">
                        <h3 class="text-lg font-medium text-green-700">Valor Total del Inventario (Costo)</h3>
                        <p id="totalInventoryValue" class="text-2xl font-bold text-green-800">0.00</p>
                    </div>
                    <div class="bg-yellow-100 p-4 rounded-lg shadow">
                        <h3 class="text-lg font-medium text-yellow-700">Ganancia Bruta Total (Ventas)</h3>
                        <p id="totalGrossProfit" class="text-2xl font-bold text-yellow-800">0.00</p>
                    </div>
                </div>
            </div>

            <div id="inventory-content" class="tab-pane hidden p-4 bg-white rounded-lg shadow">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold">Gestión de Inventario</h2>
                    <button id="openAddProductModal" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                        <i data-lucide="plus-circle" class="mr-2"></i>Añadir Producto
                    </button>
                </div>
                <div class="mb-4">
                    <label for="searchProductQR" class="block text-sm font-medium text-gray-700">Buscar Producto por QR/Nombre:</label>
                    <div class="flex">
                        <input type="text" id="searchProductQR" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="Ingresar o escanear QR / Escribir nombre...">
                        <button id="scanProductQRInventory" class="ml-2 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-3 rounded-lg">
                            <i data-lucide="scan-line"></i>
                        </button>
                    </div>
                </div>
                <div id="inventoryQRScannerContainer" class="mb-4 hidden">
                    <div id="inventory-qr-reader" class="w-full md:w-1/2 mx-auto"></div>
                    <button id="stopInventoryQRScan" class="mt-2 bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg block mx-auto">Detener Escaneo</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">QR (ID)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">P. Costo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">P. Venta</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock Mín.</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="productList" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="sales-content" class="tab-pane hidden p-4 bg-white rounded-lg shadow">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold">Gestión de Ventas</h2>
                    <button id="openRecordSaleModal" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                        <i data-lucide="plus-circle" class="mr-2"></i>Registrar Venta
                    </button>
                </div>
                <h3 class="text-xl font-semibold mb-2">Historial de Ventas</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tienda</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Productos</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monto Total</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ganancia Bruta</th>
                            </tr>
                        </thead>
                        <tbody id="salesHistory" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="stores-content" class="tab-pane hidden p-4 bg-white rounded-lg shadow">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold">Gestión de Tiendas</h2>
                    <button id="openAddStoreModal" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                        <i data-lucide="plus-circle" class="mr-2"></i>Añadir Tienda
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Tienda</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre de Tienda</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="storeList" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            </div>
            
            <div id="importExport-content" class="tab-pane hidden p-4 bg-white rounded-lg shadow">
                <h2 class="text-2xl font-semibold mb-4">Importar y Exportar Datos</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-xl font-medium mb-2">Exportar Inventario</h3>
                        <p class="text-sm text-gray-600 mb-2">Descarga tu inventario actual en formato Excel (.xlsx).</p>
                        <button id="exportInventory" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                            <i data-lucide="download" class="mr-2"></i>Exportar a Excel
                        </button>
                    </div>
                    <div>
                        <h3 class="text-xl font-medium mb-2">Importar Inventario</h3>
                        <p class="text-sm text-gray-600 mb-2">Sube un archivo Excel (.xlsx) para añadir o actualizar productos. El archivo debe tener las columnas: QR_ID (opcional, se autogenerará si está vacío), Nombre, Cantidad, PrecioCosto, PrecioVenta, StockMinimo.</p>
                        <input type="file" id="importFile" accept=".xlsx" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100 mb-2">
                        <button id="importInventory" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                            <i data-lucide="upload" class="mr-2"></i>Importar desde Excel
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="productModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full items-center justify-center">
        <div class="relative mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="productModalTitle">Añadir Producto</h3>
                <form id="productForm" class="mt-2 space-y-4">
                    <input type="hidden" id="productId"> <div>
                        <label for="productQR" class="block text-sm font-medium text-gray-700 text-left">Código QR (ID Único - dejar en blanco para autogenerar):</label>
                        <input type="text" id="productQR" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>
                    <div>
                        <label for="productName" class="block text-sm font-medium text-gray-700 text-left">Nombre del Producto:</label>
                        <input type="text" id="productName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>
                    <div>
                        <label for="productQuantity" class="block text-sm font-medium text-gray-700 text-left">Cantidad Actual:</label>
                        <input type="number" id="productQuantity" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" min="0">
                    </div>
                    <div>
                        <label for="productCostPrice" class="block text-sm font-medium text-gray-700 text-left">Precio de Costo:</label>
                        <input type="number" id="productCostPrice" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" min="0" step="0.01">
                    </div>
                    <div>
                        <label for="productSalePrice" class="block text-sm font-medium text-gray-700 text-left">Precio de Venta:</label>
                        <input type="number" id="productSalePrice" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" min="0" step="0.01">
                    </div>
                    <div>
                        <label for="productMinStock" class="block text-sm font-medium text-gray-700 text-left">Nivel Mínimo de Stock:</label>
                        <input type="number" id="productMinStock" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" min="0" value="0">
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="saveProductButton" type="submit" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">Guardar Producto</button>
                        <button id="closeProductModal" type="button" class="mt-2 px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div id="viewQRModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full items-center justify-center">
        <div class="relative mx-auto p-5 border w-auto max-w-xs shadow-lg rounded-md bg-white">
            <h3 class="text-lg leading-6 font-medium text-gray-900 text-center mb-4">Código QR del Producto</h3>
            <canvas id="qrCanvas" class="mx-auto"></canvas>
            <p id="qrCodeText" class="text-center font-mono mt-2"></p>
            <button id="closeViewQRModal" type="button" class="mt-4 px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400">Cerrar</button>
        </div>
    </div>

    <div id="storeModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full items-center justify-center">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" id="storeModalTitle">Añadir Nueva Tienda</h3>
            <form id="storeForm" class="mt-4 space-y-4">
                <input type="hidden" id="storeId">
                <div>
                    <label for="storeName" class="block text-sm font-medium text-gray-700">Nombre de la Tienda:</label>
                    <input type="text" id="storeName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                <div class="items-center px-4 py-3">
                    <button id="saveStoreButton" type="submit" class="px-4 py-2 bg-purple-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-purple-600">Guardar Tienda</button>
                    <button id="closeStoreModal" type="button" class="mt-2 px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="recordSaleModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full items-center justify-center">
        <div class="relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <h3 class="text-lg leading-6 font-medium text-gray-900 text-center mb-4">Registrar Nueva Venta</h3>
            <form id="saleForm" class="space-y-4">
                <div>
                    <label for="saleStore" class="block text-sm font-medium text-gray-700">Seleccionar Tienda:</label>
                    <select id="saleStore" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        </select>
                </div>

                <div class="border p-3 rounded-md">
                    <h4 class="text-md font-medium mb-2">Añadir Producto a la Venta:</h4>
                    <div class="flex items-center space-x-2 mb-2">
                        <input type="text" id="saleSearchProduct" class="block w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="Buscar por nombre o escanear QR...">
                        <button type="button" id="scanProductQRSale" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-3 rounded-lg">
                            <i data-lucide="scan-line"></i>
                        </button>
                    </div>
                    <div id="saleQRScannerContainer" class="mb-2 hidden">
                         <div id="sale-qr-reader" class="w-full md:w-1/2 mx-auto"></div>
                         <button id="stopSaleQRScan" class="mt-2 bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg block mx-auto">Detener Escaneo</button>
                    </div>
                    <div id="saleProductSearchResults" class="product-search-results border rounded bg-white shadow"></div>
                </div>

                <div class="border p-3 rounded-md">
                    <h4 class="text-md font-medium mb-2">Productos en esta Venta:</h4>
                    <div id="saleItemsList" class="space-y-2 max-h-60 overflow-y-auto">
                        </div>
                    <p class="text-right font-bold mt-2">Total Venta: <span id="saleTotalAmount">0.00</span></p>
                </div>

                <div class="items-center px-4 py-3">
                    <button id="saveSaleButton" type="submit" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600">Confirmar Venta</button>
                    <button id="closeSaleModal" type="button" class="mt-2 px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmationModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full items-center justify-center">
        <div class="relative mx-auto p-5 border w-full max-w-sm shadow-lg rounded-md bg-white">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="confirmationTitle">Confirmar Acción</h3>
            <p id="confirmationMessage" class="mt-2 text-sm text-gray-600">¿Estás seguro?</p>
            <div class="mt-4 flex justify-end space-x-2">
                <button id="confirmActionButton" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md hover:bg-red-600">Confirmar</button>
                <button id="cancelActionButton" class="px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md hover:bg-gray-400">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white py-3 px-5 rounded-lg shadow-lg transition-opacity duration-300 opacity-0 z-50">
        <p id="toastMessage"></p>
    </div>

    <script>
        // --- In-memory Data Storage ---
        let localProducts = []; // Stores product objects { id, name, quantity, costPrice, salePrice, minStock }
        let localStores = [];   // Stores store objects { id, name }
        let localSales = [];    // Stores sale objects { id, date, storeId, storeName, items: [], totalAmount, totalProfit }
        
        let currentEditingProductId = null; // Stores the ID of the product being edited
        let currentEditingStoreId = null; // Stores the ID of the store being edited
        let inventoryQrScanner = null;
        let saleQrScanner = null;
        let currentSaleItems = []; // Temporary storage for items in the current sale being recorded

        // --- DOMContentLoaded to initialize ---
        document.addEventListener('DOMContentLoaded', () => {
            loadInitialData();
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            } else {
                console.warn("Lucide icons no están disponibles al cargar la página.");
            }
        });
        
        // --- Toast Notifications ---
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.classList.remove('opacity-0', 'bg-red-500', 'bg-green-500', 'bg-blue-500', 'bg-yellow-500'); // Ensure all color classes are removed first
            
            if (type === 'error') {
                toast.classList.add('bg-red-500');
            } else if (type === 'info') {
                toast.classList.add('bg-blue-500');
            } else if (type === 'warning') {
                toast.classList.add('bg-yellow-500');
            } else { // success
                toast.classList.add('bg-green-600');
            }
            toast.classList.add('opacity-100');
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
            }, 3000);
        }
        
        // --- Tab Navigation ---
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabPanes = document.querySelectorAll('.tab-pane');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                const tab = button.getAttribute('data-tab');
                tabPanes.forEach(pane => {
                    if (pane.id === `${tab}-content`) {
                        pane.classList.remove('hidden');
                        pane.classList.add('active');
                    } else {
                        pane.classList.remove('active');
                        pane.classList.add('hidden');
                    }
                });
                stopAllScanners(); // Stop scanners when changing tabs
            });
        });

        // --- Modal Helper Functions ---
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.add('active');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.remove('active');
        }
        
        // --- Confirmation Modal ---
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmActionButton = document.getElementById('confirmActionButton');
        const cancelActionButton = document.getElementById('cancelActionButton');
        let currentConfirmAction = null;

        function showConfirmationModal(title, message, onConfirm) {
            document.getElementById('confirmationTitle').textContent = title;
            document.getElementById('confirmationMessage').textContent = message;
            currentConfirmAction = onConfirm;
            openModal('confirmationModal');
        }

        confirmActionButton.addEventListener('click', () => {
            if (currentConfirmAction) {
                currentConfirmAction();
            }
            closeModal('confirmationModal');
            currentConfirmAction = null; // Reset action
        });
        cancelActionButton.addEventListener('click', () => {
            closeModal('confirmationModal');
            currentConfirmAction = null; // Reset action
        });

        // --- Store Management ---
        const storeModal = document.getElementById('storeModal');
        const storeForm = document.getElementById('storeForm');
        const storeListEl = document.getElementById('storeList'); // Renamed to avoid conflict
        const saleStoreSelect = document.getElementById('saleStore');

        document.getElementById('openAddStoreModal').addEventListener('click', () => {
            storeForm.reset();
            currentEditingStoreId = null;
            document.getElementById('storeModalTitle').textContent = 'Añadir Nueva Tienda';
            openModal('storeModal');
        });
        document.getElementById('closeStoreModal').addEventListener('click', () => closeModal('storeModal'));

        storeForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const storeName = document.getElementById('storeName').value.trim();
            if (!storeName) {
                showToast("El nombre de la tienda es obligatorio.", "error");
                return;
            }

            if (currentEditingStoreId) { // Editing existing store
                const storeIndex = localStores.findIndex(s => s.id === currentEditingStoreId);
                if (storeIndex > -1) {
                    localStores[storeIndex].name = storeName;
                    showToast("Tienda actualizada con éxito.");
                } else {
                    showToast("Error: Tienda no encontrada para actualizar.", "error");
                }
            } else { // Adding new store
                 // Check if store name already exists (case-insensitive)
                if (localStores.some(s => s.name.toLowerCase() === storeName.toLowerCase())) {
                    showToast("Error: Ya existe una tienda con este nombre.", "error");
                    return;
                }
                const newStore = {
                    id: crypto.randomUUID(), // Generate unique ID for the store
                    name: storeName
                };
                localStores.push(newStore);
                showToast("Tienda añadida con éxito.");
            }
            
            renderStores();
            closeModal('storeModal');
            currentEditingStoreId = null;
        });
        
        function renderStores() {
            storeListEl.innerHTML = '';
            saleStoreSelect.innerHTML = '<option value="">Seleccione una tienda</option>';
            
            if (localStores.length === 0) {
                storeListEl.innerHTML = '<tr><td colspan="3" class="text-center py-4">No hay tiendas registradas.</td></tr>';
            } else {
                localStores.forEach(store => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${store.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${store.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button data-id="${store.id}" class="edit-store-btn text-indigo-600 hover:text-indigo-900 mr-2" title="Editar"><i data-lucide="edit" class="inline-block"></i></button>
                            <button data-id="${store.id}" class="delete-store-btn text-red-600 hover:text-red-900" title="Eliminar"><i data-lucide="trash-2" class="inline-block"></i></button>
                        </td>
                    `;
                    storeListEl.appendChild(tr);

                    const option = document.createElement('option');
                    option.value = store.id; // Use store ID as value
                    option.textContent = store.name;
                    saleStoreSelect.appendChild(option);
                });
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();

            document.querySelectorAll('.edit-store-btn').forEach(button => {
                button.addEventListener('click', (e) => loadStoreForEdit(e.currentTarget.getAttribute('data-id')));
            });
            document.querySelectorAll('.delete-store-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const storeIdToDelete = e.currentTarget.getAttribute('data-id');
                    const storeName = localStores.find(s => s.id === storeIdToDelete)?.name || storeIdToDelete;
                    showConfirmationModal('Eliminar Tienda', `¿Estás seguro de que quieres eliminar la tienda "${storeName}"? Esta acción no se puede deshacer.`, () => deleteStore(storeIdToDelete));
                });
            });
        }

        function loadStoreForEdit(storeId) {
            const store = localStores.find(s => s.id === storeId);
            if (store) {
                currentEditingStoreId = store.id;
                document.getElementById('storeModalTitle').textContent = 'Editar Tienda';
                document.getElementById('storeId').value = store.id;
                document.getElementById('storeName').value = store.name;
                openModal('storeModal');
            } else {
                showToast("Tienda no encontrada.", "error");
            }
        }

        function deleteStore(storeId) {
            // Check if the store is used in any sales
            const isStoreUsedInSales = localSales.some(sale => sale.storeId === storeId);
            if (isStoreUsedInSales) {
                showToast("No se puede eliminar la tienda porque tiene ventas asociadas. Elimine primero las ventas o asígnelas a otra tienda (funcionalidad no implementada).", "error");
                return;
            }

            localStores = localStores.filter(s => s.id !== storeId);
            showToast("Tienda eliminada con éxito.");
            renderStores();
        }


        // --- Product Management ---
        const productModal = document.getElementById('productModal');
        const productForm = document.getElementById('productForm');
        const productListElement = document.getElementById('productList');
        const searchProductQRInput = document.getElementById('searchProductQR');

        document.getElementById('openAddProductModal').addEventListener('click', () => {
            productForm.reset();
            currentEditingProductId = null;
            document.getElementById('productModalTitle').textContent = 'Añadir Producto';
            document.getElementById('productQR').disabled = false; // Allow editing QR for new products
            document.getElementById('productId').value = ''; // Clear hidden product ID field
            openModal('productModal');
        });
        document.getElementById('closeProductModal').addEventListener('click', () => closeModal('productModal'));

        productForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            let productQR = document.getElementById('productQR').value.trim();
            const productName = document.getElementById('productName').value.trim();
            const productQuantity = parseInt(document.getElementById('productQuantity').value);
            const productCostPrice = parseFloat(document.getElementById('productCostPrice').value);
            const productSalePrice = parseFloat(document.getElementById('productSalePrice').value);
            const productMinStock = parseInt(document.getElementById('productMinStock').value) || 0;

            if (!productName || isNaN(productQuantity) || isNaN(productCostPrice) || isNaN(productSalePrice)) {
                showToast("Por favor, completa todos los campos obligatorios correctamente.", "error");
                return;
            }
            if (productCostPrice > productSalePrice) {
                showToast("El precio de costo no puede ser mayor al precio de venta.", "error");
                 return; 
            }

            const productData = {
                name: productName,
                quantity: productQuantity,
                costPrice: productCostPrice,
                salePrice: productSalePrice,
                minStock: productMinStock,
            };

            if (currentEditingProductId) { // Editing existing product
                const productIndex = localProducts.findIndex(p => p.id === currentEditingProductId);
                if (productIndex > -1) {
                    // If productQR field was changed and it's different from original ID, check for conflicts
                    if (productQR && productQR !== currentEditingProductId && localProducts.some(p => p.id === productQR)) {
                        showToast("Error: El nuevo Código QR/ID ya existe para otro producto.", "error");
                        return;
                    }
                    localProducts[productIndex] = { ...localProducts[productIndex], ...productData, id: productQR || currentEditingProductId }; // Update ID if changed
                    showToast("Producto actualizado con éxito.");
                } else {
                     showToast("Error: Producto no encontrado para actualizar.", "error");
                }
            } else { // Adding new product
                if (!productQR) { 
                    productQR = crypto.randomUUID(); // Autogenerate QR if empty
                } else if (localProducts.some(p => p.id === productQR)) {
                    showToast("Error: Ya existe un producto con este Código QR/ID.", "error");
                    return;
                }
                productData.id = productQR;
                localProducts.push(productData);
                showToast("Producto añadido con éxito.");
            }
            
            renderProducts();
            closeModal('productModal');
            productForm.reset();
            currentEditingProductId = null;
        });
        
        function getStockStatus(quantity, minStock) {
            if (quantity <= 0) return { text: "Agotado", class: "out-of-stock" };
            if (quantity <= minStock) return { text: "Stock Bajo", class: "low-stock" };
            return { text: "En Stock", class: "in-stock" };
        }

        function renderProducts() {
            productListElement.innerHTML = '';
            if (localProducts.length === 0) {
                productListElement.innerHTML = '<tr><td colspan="8" class="text-center py-4">No hay productos en el inventario.</td></tr>';
            } else {
                const searchTerm = searchProductQRInput.value.toLowerCase().trim();
                const filteredProducts = localProducts.filter(product => 
                    product.id.toLowerCase().includes(searchTerm) || 
                    product.name.toLowerCase().includes(searchTerm)
                );

                filteredProducts.forEach(product => {
                    const stockStatus = getStockStatus(product.quantity, product.minStock);
                    const tr = document.createElement('tr');
                    tr.classList.add(stockStatus.class.split(' ')[0]); // Add base class for styling

                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <canvas class="product-qr-canvas inline-block" data-qr="${product.id}" width="40" height="40"></canvas>
                            <span class="text-xs block">${product.id}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">${product.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${product.quantity}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${product.costPrice.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${product.salePrice.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${product.minStock}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${stockStatus.class}">${stockStatus.text}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button data-id="${product.id}" class="view-qr-btn text-blue-600 hover:text-blue-900 mr-2" title="Ver QR"><i data-lucide="qr-code" class="inline-block"></i></button>
                            <button data-id="${product.id}" class="edit-product-btn text-indigo-600 hover:text-indigo-900 mr-2" title="Editar"><i data-lucide="edit" class="inline-block"></i></button>
                            <button data-id="${product.id}" class="delete-product-btn text-red-600 hover:text-red-900" title="Eliminar"><i data-lucide="trash-2" class="inline-block"></i></button>
                        </td>
                    `;
                    productListElement.appendChild(tr);

                    const canvas = tr.querySelector('.product-qr-canvas');
                    if (canvas && typeof QRious !== 'undefined') {
                        new QRious({ element: canvas, value: product.id, size: 40, level: 'H' });
                    }
                });
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
            
            document.querySelectorAll('.edit-product-btn').forEach(button => {
                button.addEventListener('click', (e) => loadProductForEdit(e.currentTarget.getAttribute('data-id')));
            });
            document.querySelectorAll('.delete-product-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                     const productIdToDelete = e.currentTarget.getAttribute('data-id');
                     const productName = localProducts.find(p => p.id === productIdToDelete)?.name || productIdToDelete;
                     showConfirmationModal('Eliminar Producto', `¿Estás seguro de que quieres eliminar el producto "${productName}"? Esta acción no se puede deshacer.`, () => deleteProduct(productIdToDelete));
                });
            });
            document.querySelectorAll('.view-qr-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const qrValue = e.currentTarget.getAttribute('data-id');
                    const qrCanvas = document.getElementById('qrCanvas');
                    document.getElementById('qrCodeText').textContent = qrValue;
                    if (typeof QRious !== 'undefined') {
                         new QRious({ element: qrCanvas, value: qrValue, size: 200, level: 'H' });
                    }
                    openModal('viewQRModal');
                });
            });
            calculateFinancials();
        }
        document.getElementById('closeViewQRModal').addEventListener('click', () => closeModal('viewQRModal'));


        function loadProductForEdit(productId) {
            const product = localProducts.find(p => p.id === productId);
            if (product) {
                currentEditingProductId = product.id;
                document.getElementById('productModalTitle').textContent = 'Editar Producto';
                document.getElementById('productId').value = product.id; // Store original ID for reference
                document.getElementById('productQR').value = product.id; 
                document.getElementById('productQR').disabled = false; // Allow editing QR, but be careful with duplicates
                document.getElementById('productName').value = product.name;
                document.getElementById('productQuantity').value = product.quantity;
                document.getElementById('productCostPrice').value = product.costPrice;
                document.getElementById('productSalePrice').value = product.salePrice;
                document.getElementById('productMinStock').value = product.minStock;
                openModal('productModal');
            } else {
                showToast("Producto no encontrado.", "error");
            }
        }

        function deleteProduct(productId) {
            // Check if product is in any sale
            const isProductInSale = localSales.some(sale => sale.items.some(item => item.productId === productId));
            if (isProductInSale) {
                showToast("No se puede eliminar el producto porque está incluido en ventas registradas.", "error");
                return;
            }
            localProducts = localProducts.filter(p => p.id !== productId);
            showToast("Producto eliminado con éxito.");
            renderProducts();
        }
        
        searchProductQRInput.addEventListener('input', () => renderProducts()); // Re-render on search

        // --- Sales Management ---
        const recordSaleModal = document.getElementById('recordSaleModal');
        const saleForm = document.getElementById('saleForm');
        const salesHistoryTable = document.getElementById('salesHistory');
        const saleSearchProductInput = document.getElementById('saleSearchProduct');
        const saleProductSearchResultsDiv = document.getElementById('saleProductSearchResults');
        const saleItemsListDiv = document.getElementById('saleItemsList');
        const saleTotalAmountSpan = document.getElementById('saleTotalAmount');

        document.getElementById('openRecordSaleModal').addEventListener('click', () => {
            saleForm.reset();
            currentSaleItems = [];
            updateSaleItemsList();
            updateSaleTotal();
            saleProductSearchResultsDiv.innerHTML = ''; 
            saleSearchProductInput.value = ''; 
            
            // Populate store select - already handled by renderStores calling loadInitialData
            if (localStores.length === 0) {
                showToast("No hay tiendas registradas. Por favor, añada una tienda primero.", "warning");
                // Optionally, could redirect to stores tab or disable button
                return;
            }
            renderStores(); // Ensure saleStoreSelect is populated
            openModal('recordSaleModal');
        });
        document.getElementById('closeSaleModal').addEventListener('click', () => {
            closeModal('recordSaleModal');
            stopSaleQRScanner(); 
        });

        saleSearchProductInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.trim().toLowerCase();
            if (searchTerm.length < 1) { // Show results even for 1 character
                saleProductSearchResultsDiv.innerHTML = '';
                saleProductSearchResultsDiv.classList.add('hidden');
                return;
            }
            
            const results = localProducts.filter(product => 
                product.quantity > 0 && // Only show products in stock
                (product.name.toLowerCase().includes(searchTerm) || product.id.toLowerCase().includes(searchTerm))
            );
            renderSaleProductSearchResults(results);
        });

        function renderSaleProductSearchResults(products) {
            saleProductSearchResultsDiv.innerHTML = '';
            if (products.length === 0) {
                saleProductSearchResultsDiv.innerHTML = '<p class="p-2 text-gray-500">No se encontraron productos disponibles.</p>';
            } else {
                products.forEach(product => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'p-2 border-b cursor-pointer product-search-item';
                    itemDiv.textContent = `${product.name} (Stock: ${product.quantity}, Precio: ${product.salePrice.toFixed(2)}) - ID: ${product.id}`;
                    itemDiv.addEventListener('click', () => addProductToSale(product));
                    saleProductSearchResultsDiv.appendChild(itemDiv);
                });
            }
            saleProductSearchResultsDiv.classList.remove('hidden');
        }
        
        function addProductToSale(product) {
            if (product.quantity <= 0) {
                showToast(`"${product.name}" está agotado.`, "error");
                return;
            }

            const existingItem = currentSaleItems.find(item => item.productId === product.id);
            if (existingItem) {
                const productInStock = localProducts.find(p => p.id === product.id);
                if (productInStock && existingItem.quantity < productInStock.quantity) {
                    existingItem.quantity++;
                } else {
                    showToast(`No hay más stock disponible para "${product.name}".`, "warning");
                }
            } else {
                currentSaleItems.push({
                    productId: product.id,
                    productName: product.name,
                    quantity: 1,
                    unitPrice: product.salePrice,
                    costPrice: product.costPrice 
                });
            }
            updateSaleItemsList();
            updateSaleTotal();
            saleSearchProductInput.value = ''; 
            saleProductSearchResultsDiv.innerHTML = ''; 
            saleProductSearchResultsDiv.classList.add('hidden');
        }

        function updateSaleItemsList() {
            saleItemsListDiv.innerHTML = '';
            if (currentSaleItems.length === 0) {
                saleItemsListDiv.innerHTML = '<p class="text-gray-500">Aún no hay productos en esta venta.</p>';
            } else {
                currentSaleItems.forEach((item, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex justify-between items-center p-2 border rounded';
                    itemDiv.innerHTML = `
                        <div>
                            <p class="font-medium">${item.productName}</p>
                            <p class="text-sm text-gray-600">Precio: ${item.unitPrice.toFixed(2)} c/u</p>
                        </div>
                        <div class="flex items-center">
                            <button type="button" data-index="${index}" class="decrease-qty-btn bg-gray-200 px-2 py-1 rounded-l hover:bg-gray-300">-</button>
                            <span class="px-3">${item.quantity}</span>
                            <button type="button" data-index="${index}" class="increase-qty-btn bg-gray-200 px-2 py-1 rounded-r hover:bg-gray-300">+</button>
                            <button type="button" data-index="${index}" class="remove-item-btn text-red-500 hover:text-red-700 ml-3"><i data-lucide="trash-2" class="inline-block"></i></button>
                        </div>
                    `;
                    saleItemsListDiv.appendChild(itemDiv);
                });
            }
            if(typeof lucide !== 'undefined') lucide.createIcons();

            document.querySelectorAll('.decrease-qty-btn').forEach(btn => btn.addEventListener('click', (e) => updateSaleItemQuantity(parseInt(e.currentTarget.dataset.index), -1)));
            document.querySelectorAll('.increase-qty-btn').forEach(btn => btn.addEventListener('click', (e) => updateSaleItemQuantity(parseInt(e.currentTarget.dataset.index), 1)));
            document.querySelectorAll('.remove-item-btn').forEach(btn => btn.addEventListener('click', (e) => removeSaleItem(parseInt(e.currentTarget.dataset.index))));
        }
        
        function updateSaleItemQuantity(index, change) {
            const item = currentSaleItems[index];
            if (!item) return;

            const newQuantity = item.quantity + change;

            if (newQuantity <= 0) { 
                removeSaleItem(index);
                return;
            }
            
            const productInStock = localProducts.find(p => p.id === item.productId);
            if (productInStock && newQuantity > productInStock.quantity) {
                showToast(`Stock insuficiente para "${item.productName}". Disponible: ${productInStock.quantity}.`, "warning");
                return; 
            }
            item.quantity = newQuantity;
            
            updateSaleItemsList();
            updateSaleTotal();
        }

        function removeSaleItem(index) {
            currentSaleItems.splice(index, 1);
            updateSaleItemsList();
            updateSaleTotal();
        }

        function updateSaleTotal() {
            const total = currentSaleItems.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0);
            saleTotalAmountSpan.textContent = total.toFixed(2);
        }

        saleForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const saleStoreElement = document.getElementById('saleStore');
            const storeId = saleStoreElement.value;
            const storeName = saleStoreElement.options[saleStoreElement.selectedIndex]?.text || "Tienda Desconocida";

            if (!storeId) {
                showToast("Por favor, seleccione una tienda.", "error");
                return;
            }
            if (currentSaleItems.length === 0) {
                showToast("Añada al menos un producto a la venta.", "error");
                return;
            }

            // Create a deep copy of currentSaleItems for the sale record
            const saleItemsForRecord = JSON.parse(JSON.stringify(currentSaleItems));

            const saleData = {
                id: crypto.randomUUID(), // Unique ID for the sale
                storeId: storeId,
                storeName: storeName,
                items: saleItemsForRecord.map(item => ({ 
                    productId: item.productId,
                    productName: item.productName,
                    quantity: item.quantity,
                    unitPrice: item.unitPrice,
                    totalItemPrice: item.quantity * item.unitPrice,
                    itemCost: item.costPrice, // Cost price at the time of sale
                    itemProfit: (item.unitPrice - item.costPrice) * item.quantity 
                })),
                totalAmount: parseFloat(saleTotalAmountSpan.textContent),
                totalProfit: saleItemsForRecord.reduce((sum, item) => sum + (item.unitPrice - item.costPrice) * item.quantity, 0),
                date: new Date().toISOString()
            };

            // Update product quantities in localProducts
            let stockSufficient = true;
            saleData.items.forEach(item => {
                const productIndex = localProducts.findIndex(p => p.id === item.productId);
                if (productIndex > -1) {
                    if (localProducts[productIndex].quantity >= item.quantity) {
                        localProducts[productIndex].quantity -= item.quantity;
                    } else {
                        showToast(`Stock insuficiente para ${item.productName} al momento de confirmar. Venta cancelada.`, "error");
                        stockSufficient = false;
                    }
                } else {
                    showToast(`Producto ${item.productName} no encontrado en inventario. Venta cancelada.`, "error");
                    stockSufficient = false;
                }
            });

            if (!stockSufficient) {
                // Re-render products to show correct stock if sale failed mid-way (though it shouldn't reach here if checks are good)
                renderProducts(); 
                return;
            }

            localSales.push(saleData);
            showToast("Venta registrada y stock actualizado con éxito.");
            
            renderProducts(); // Update product list with new quantities
            renderSalesHistory();
            calculateFinancials();
            
            closeModal('recordSaleModal');
            currentSaleItems = []; // Clear items for next sale
        });
        
        function renderSalesHistory() {
            salesHistoryTable.innerHTML = '';
             if (localSales.length === 0) {
                salesHistoryTable.innerHTML = '<tr><td colspan="5" class="text-center py-4">No hay ventas registradas.</td></tr>';
            } else {
                // Sort sales by date, most recent first
                const sortedSales = [...localSales].sort((a, b) => new Date(b.date) - new Date(a.date));

                sortedSales.forEach(sale => {
                    const tr = document.createElement('tr');
                    const itemsSummary = sale.items.map(item => `${item.productName} (x${item.quantity})`).join(', ');
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${new Date(sale.date).toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${sale.storeName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${itemsSummary}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${sale.totalAmount.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${sale.totalProfit.toFixed(2)}</td>
                    `;
                    salesHistoryTable.appendChild(tr);
                });
            }
            calculateFinancials();
        }

        // --- QR Code Scanning ---
        function onScanSuccess(decodedText, context) {
            console.log(`Code matched = ${decodedText}`);
            if (context === 'inventory') {
                searchProductQRInput.value = decodedText;
                renderProducts(); // Filter based on new input
                stopInventoryQRScanner();
            } else if (context === 'sale') {
                saleSearchProductInput.value = decodedText;
                // Trigger input event to search for the product
                const event = new Event('input', { bubbles: true, cancelable: true });
                saleSearchProductInput.dispatchEvent(event);
                stopSaleQRScanner();
            }
        }

        function onScanFailure(error) {
            // console.warn(`Code scan error = ${error}`); // Can be noisy
        }

        function startInventoryQRScanner() {
            const qrReaderDiv = document.getElementById('inventory-qr-reader');
            const container = document.getElementById('inventoryQRScannerContainer');
            if (!Html5Qrcode) { showToast("Librería de escaneo QR no cargada.", "error"); return; }
            
            container.classList.remove('hidden');
            qrReaderDiv.innerHTML = ''; 

            if (!inventoryQrScanner) {
                 inventoryQrScanner = new Html5Qrcode("inventory-qr-reader");
            }
           
            inventoryQrScanner.start(
                { facingMode: "environment" }, 
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText, decodedResult) => onScanSuccess(decodedText, 'inventory'),
                (errorMessage) => onScanFailure(errorMessage)
            ).catch(err => {
                console.error("Error iniciando escáner de inventario:", err);
                showToast("Error al iniciar escáner QR (inventario): " + (err.message || err), "error");
                container.classList.add('hidden');
            });
        }
        
        function stopInventoryQRScanner() {
            const container = document.getElementById('inventoryQRScannerContainer');
            if (inventoryQrScanner && inventoryQrScanner.isScanning) { 
                inventoryQrScanner.stop().then(() => {
                    console.log("Escáner de inventario detenido.");
                }).catch(err => {
                    console.warn("Advertencia al detener escáner de inventario:", err);
                }).finally(() => {
                     container.classList.add('hidden');
                });
            } else {
                 container.classList.add('hidden');
            }
        }

        document.getElementById('scanProductQRInventory').addEventListener('click', startInventoryQRScanner);
        document.getElementById('stopInventoryQRScan').addEventListener('click', stopInventoryQRScanner);

        function startSaleQRScanner() {
            const qrReaderDiv = document.getElementById('sale-qr-reader');
            const container = document.getElementById('saleQRScannerContainer');
            if (!Html5Qrcode) { showToast("Librería de escaneo QR no cargada.", "error"); return; }

            container.classList.remove('hidden');
            qrReaderDiv.innerHTML = '';

            if (!saleQrScanner) {
                saleQrScanner = new Html5Qrcode("sale-qr-reader");
            }
            
            saleQrScanner.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                 (decodedText, decodedResult) => onScanSuccess(decodedText, 'sale'),
                 (errorMessage) => onScanFailure(errorMessage)
            ).catch(err => {
                console.error("Error iniciando escáner de ventas:", err);
                showToast("Error al iniciar escáner QR (ventas): " + (err.message || err), "error");
                container.classList.add('hidden');
            });
        }

        function stopSaleQRScanner() {
            const container = document.getElementById('saleQRScannerContainer');
            if (saleQrScanner && saleQrScanner.isScanning) { 
                saleQrScanner.stop().then(() => {
                    console.log("Escáner de ventas detenido.");
                }).catch(err => {
                    console.warn("Advertencia al detener escáner de ventas:", err);
                }).finally(() => {
                    container.classList.add('hidden');
                });
            } else {
                container.classList.add('hidden');
            }
        }
        
        function stopAllScanners() {
            stopInventoryQRScanner();
            stopSaleQRScanner();
        }

        document.getElementById('scanProductQRSale').addEventListener('click', startSaleQRScanner);
        document.getElementById('stopSaleQRScan').addEventListener('click', stopSaleQRScanner);

        // --- Financial Reports ---
        function calculateFinancials() {
            const totalInventoryValue = localProducts.reduce((sum, product) => sum + (product.quantity * product.costPrice), 0);
            document.getElementById('totalInventoryValue').textContent = `$${totalInventoryValue.toFixed(2)}`;

            const totalGrossProfit = localSales.reduce((sum, sale) => sum + sale.totalProfit, 0);
            document.getElementById('totalGrossProfit').textContent = `$${totalGrossProfit.toFixed(2)}`;
        }

        // --- Import/Export Excel ---
        document.getElementById('exportInventory').addEventListener('click', () => {
            if (localProducts.length === 0) {
                showToast("No hay productos para exportar.", "info");
                return;
            }
            const dataToExport = localProducts.map(p => ({
                'QR_ID': p.id,
                'Nombre': p.name,
                'Cantidad': p.quantity,
                'PrecioCosto': p.costPrice,
                'PrecioVenta': p.salePrice,
                'StockMinimo': p.minStock
            }));
            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Inventario");
            XLSX.writeFile(workbook, "inventario_exportado_local.xlsx");
            showToast("Inventario exportado con éxito.", "success");
        });

        document.getElementById('importInventory').addEventListener('click', () => {
            const fileInput = document.getElementById('importFile');
            if (fileInput.files.length === 0) {
                showToast("Por favor, selecciona un archivo Excel para importar.", "warning");
                return;
            }
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (jsonData.length === 0) {
                        showToast("El archivo Excel está vacío o no tiene datos.", "warning");
                        return;
                    }

                    let productsAdded = 0;
                    let productsUpdated = 0;
                    let productsSkipped = 0;

                    jsonData.forEach(row => {
                        const qrId = row['QR_ID'] ? String(row['QR_ID']).trim() : null; // Keep null if not provided
                        const name = String(row['Nombre'] || '').trim();
                        const quantity = parseInt(row['Cantidad']);
                        const costPrice = parseFloat(row['PrecioCosto']);
                        const salePrice = parseFloat(row['PrecioVenta']);
                        const minStock = parseInt(row['StockMinimo']) || 0;

                        if (!name || isNaN(quantity) || isNaN(costPrice) || isNaN(salePrice)) {
                            console.warn(`Fila ignorada por datos incompletos o incorrectos: ${JSON.stringify(row)}`);
                            productsSkipped++;
                            return; // continue to next row
                        }
                         if (costPrice > salePrice) {
                            console.warn(`Fila ignorada para el producto "${name}": El precio de costo (${costPrice}) no puede ser mayor al precio de venta (${salePrice}).`);
                            showToast(`Error en producto "${name}" del archivo: Precio costo > Precio venta. Fila ignorada.`, "warning");
                            productsSkipped++;
                            return; // continue to next row
                        }

                        const productData = { name, quantity, costPrice, salePrice, minStock };
                        
                        let existingProductIndex = -1;
                        if (qrId) {
                           existingProductIndex = localProducts.findIndex(p => p.id === qrId);
                        }
                        // If no QR ID provided or not found by QR ID, try to find by name (case-insensitive)
                        if (existingProductIndex === -1) {
                            existingProductIndex = localProducts.findIndex(p => p.name.toLowerCase() === name.toLowerCase());
                        }


                        if (existingProductIndex > -1) { // Update existing product
                            const existingProductId = localProducts[existingProductIndex].id;
                            localProducts[existingProductIndex] = { 
                                ...localProducts[existingProductIndex], 
                                ...productData,
                                id: qrId || existingProductId // Use imported QR if provided and valid, else keep original
                            };
                            // If a new QR ID was provided and it's different from the original, ensure it's unique (excluding current product)
                            if (qrId && qrId !== existingProductId && localProducts.some((p, idx) => p.id === qrId && idx !== existingProductIndex)) {
                                showToast(`Conflicto de QR ID importado para "${name}". Se mantuvo el ID original.`, "warning");
                                localProducts[existingProductIndex].id = existingProductId; // Revert to original ID
                            }
                            productsUpdated++;
                        } else { // Add new product
                            productData.id = qrId || crypto.randomUUID();
                            // Ensure new QR ID (either from file or generated) is unique
                            if (localProducts.some(p => p.id === productData.id)) {
                                showToast(`QR ID "${productData.id}" para nuevo producto "${name}" ya existe. Generando uno nuevo.`, "warning");
                                productData.id = crypto.randomUUID(); // Regenerate if conflict
                            }
                            localProducts.push(productData);
                            productsAdded++;
                        }
                    });

                    if (productsAdded > 0 || productsUpdated > 0) {
                        showToast(`${productsAdded} productos añadidos, ${productsUpdated} actualizados. ${productsSkipped > 0 ? productsSkipped + ' filas ignoradas.' : ''}`, "success");
                        renderProducts();
                        renderStores(); // In case new stores were implied or for consistency
                        calculateFinancials();
                    } else if (productsSkipped > 0 && jsonData.length === productsSkipped) {
                         showToast("Todos los productos del archivo fueron ignorados debido a errores o datos faltantes.", "warning");
                    }
                    else {
                        showToast("No se procesaron nuevos productos del archivo. Verifica el formato y los datos.", "info");
                    }
                    fileInput.value = ''; // Reset file input
                } catch (error) {
                    console.error("Error importando inventario:", error);
                    showToast("Error al importar inventario: " + error.message, "error");
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // --- Initial Data Load and Render ---
        function loadInitialData() {
            // Data is already in localProducts, localStores, localSales.
            // Just need to render it.
            renderProducts();
            renderStores();
            renderSalesHistory();
            calculateFinancials();
        }

    </script>
</body>
</html>
