<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Inventario y Ventas (Firebase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@0.378.0/dist/umd/lucide.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-button.active { border-color: #3b82f6; color: #3b82f6; background-color: #eff6ff; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .low-stock { background-color: #fef9c3 !important; color: #713f12; }
        .out-of-stock { background-color: #fee2e2 !important; color: #991b1b; }
        .in-stock { background-color: #dcfce7 !important; color: #166534; }
        #qr-reader { width: 100%; max-width: 500px; border: 1px solid #ccc; }
        #qr-reader__dashboard_section_csr button { background-color: #ef4444; color: white; padding: 8px; border-radius: 5px; margin-top: 10px;}
        .product-search-results { max-height: 200px; overflow-y: auto; border: 1px solid #ccc; }
        .product-search-item:hover { background-color: #f0f0f0; }
        /* Estilos para el mensaje de carga */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 10000; /* Muy alto para estar encima de todo */
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="loadingOverlay">
        <p>Cargando datos y conectando a Firebase...</p>
    </div>

    <div class="container mx-auto p-4">
        <header class="bg-blue-600 text-white p-6 rounded-lg shadow-lg mb-6">
            <h1 class="text-3xl font-bold">Sistema de Control de Inventario y Ventas (Firebase)</h1>
            <p class="text-sm">App ID: <span id="appIdDisplay" class="font-mono"></span></p>
            <p class="text-sm">Usuario ID: <span id="userIdDisplay" class="font-mono"></span></p>
        </header>

        <div class="mb-6 flex space-x-2 border-b border-gray-300 overflow-x-auto">
            <button class="tab-button py-2 px-4 font-semibold border-b-2 border-transparent hover:border-blue-500 hover:text-blue-500 focus:outline-none active" data-tab="dashboard">
                <i data-lucide="layout-dashboard" class="inline-block mr-2"></i>Dashboard
            </button>
            <button class="tab-button py-2 px-4 font-semibold border-b-2 border-transparent hover:border-blue-500 hover:text-blue-500 focus:outline-none" data-tab="inventory">
                <i data-lucide="package" class="inline-block mr-2"></i>Inventario
            </button>
            <button class="tab-button py-2 px-4 font-semibold border-b-2 border-transparent hover:border-blue-500 hover:text-blue-500 focus:outline-none" data-tab="sales">
                <i data-lucide="shopping-cart" class="inline-block mr-2"></i>Ventas
            </button>
            <button class="tab-button py-2 px-4 font-semibold border-b-2 border-transparent hover:border-blue-500 hover:text-blue-500 focus:outline-none" data-tab="stores">
                <i data-lucide="store" class="inline-block mr-2"></i>Tiendas
            </button>
            <button class="tab-button py-2 px-4 font-semibold border-b-2 border-transparent hover:border-blue-500 hover:text-blue-500 focus:outline-none" data-tab="importExport">
                <i data-lucide="file-up" class="inline-block mr-2"></i>Importar/Exportar
            </button>
        </div>

        <main id="tab-content">
            <div id="dashboard-content" class="tab-pane active p-4 bg-white rounded-lg shadow">
                <h2 class="text-2xl font-semibold mb-4">Resumen Financiero</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-green-100 p-4 rounded-lg shadow">
                        <h3 class="text-lg font-medium text-green-700">Valor Total del Inventario (Costo)</h3>
                        <p id="totalInventoryValue" class="text-2xl font-bold text-green-800">0.00</p>
                    </div>
                    <div class="bg-yellow-100 p-4 rounded-lg shadow">
                        <h3 class="text-lg font-medium text-yellow-700">Ganancia Bruta Total (Ventas)</h3>
                        <p id="totalGrossProfit" class="text-2xl font-bold text-yellow-800">0.00</p>
                    </div>
                </div>
            </div>

            <div id="inventory-content" class="tab-pane hidden p-4 bg-white rounded-lg shadow">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold">Gestión de Inventario</h2>
                    <button id="openAddProductModal" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                        <i data-lucide="plus-circle" class="mr-2"></i>Añadir Producto
                    </button>
                </div>
                <div class="mb-4">
                    <label for="searchProductQR" class="block text-sm font-medium text-gray-700">Buscar Producto por QR/Nombre:</label>
                    <div class="flex">
                        <input type="text" id="searchProductQR" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="Ingresar o escanear QR / Escribir nombre...">
                        <button id="scanProductQRInventory" class="ml-2 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-3 rounded-lg">
                            <i data-lucide="scan-line"></i>
                        </button>
                    </div>
                </div>
                <div id="inventoryQRScannerContainer" class="mb-4 hidden">
                    <div id="inventory-qr-reader" class="w-full md:w-1/2 mx-auto"></div>
                    <button id="stopInventoryQRScan" class="mt-2 bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg block mx-auto">Detener Escaneo</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">QR (ID)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">P. Costo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">P. Venta</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock Mín.</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="productList" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="sales-content" class="tab-pane hidden p-4 bg-white rounded-lg shadow">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold">Gestión de Ventas</h2>
                    <button id="openRecordSaleModal" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                        <i data-lucide="plus-circle" class="mr-2"></i>Registrar Venta
                    </button>
                </div>
                <h3 class="text-xl font-semibold mb-2">Historial de Ventas</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tienda</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Productos</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monto Total</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ganancia Bruta</th>
                            </tr>
                        </thead>
                        <tbody id="salesHistory" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="stores-content" class="tab-pane hidden p-4 bg-white rounded-lg shadow">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold">Gestión de Tiendas</h2>
                    <button id="openAddStoreModal" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                        <i data-lucide="plus-circle" class="mr-2"></i>Añadir Tienda
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Tienda</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre de Tienda</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="storeList" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            </div>
            
            <div id="importExport-content" class="tab-pane hidden p-4 bg-white rounded-lg shadow">
                <h2 class="text-2xl font-semibold mb-4">Importar y Exportar Datos</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-xl font-medium mb-2">Exportar Inventario</h3>
                        <p class="text-sm text-gray-600 mb-2">Descarga tu inventario actual en formato Excel (.xlsx).</p>
                        <button id="exportInventory" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                            <i data-lucide="download" class="mr-2"></i>Exportar a Excel
                        </button>
                    </div>
                    <div>
                        <h3 class="text-xl font-medium mb-2">Importar Inventario</h3>
                        <p class="text-sm text-gray-600 mb-2">Sube un archivo Excel (.xlsx) para añadir o actualizar productos. El archivo debe tener las columnas: QR_ID (opcional, se autogenerará si está vacío), Nombre, Cantidad, PrecioCosto, PrecioVenta, StockMinimo.</p>
                        <input type="file" id="importFile" accept=".xlsx" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100 mb-2">
                        <button id="importInventory" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                            <i data-lucide="upload" class="mr-2"></i>Importar desde Excel
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="productModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full items-center justify-center">
        <div class="relative mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="productModalTitle">Añadir Producto</h3>
                <form id="productForm" class="mt-2 space-y-4">
                    <input type="hidden" id="productId"> <div>
                        <label for="productQR" class="block text-sm font-medium text-gray-700 text-left">Código QR (ID Único - dejar en blanco para autogenerar):</label>
                        <input type="text" id="productQR" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>
                    <div>
                        <label for="productName" class="block text-sm font-medium text-gray-700 text-left">Nombre del Producto:</label>
                        <input type="text" id="productName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>
                    <div>
                        <label for="productQuantity" class="block text-sm font-medium text-gray-700 text-left">Cantidad Actual:</label>
                        <input type="number" id="productQuantity" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" min="0">
                    </div>
                    <div>
                        <label for="productCostPrice" class="block text-sm font-medium text-gray-700 text-left">Precio de Costo:</label>
                        <input type="number" id="productCostPrice" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" min="0" step="0.01">
                    </div>
                    <div>
                        <label for="productSalePrice" class="block text-sm font-medium text-gray-700 text-left">Precio de Venta:</label>
                        <input type="number" id="productSalePrice" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" min="0" step="0.01">
                    </div>
                    <div>
                        <label for="productMinStock" class="block text-sm font-medium text-gray-700 text-left">Nivel Mínimo de Stock:</label>
                        <input type="number" id="productMinStock" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" min="0" value="0">
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="saveProductButton" type="submit" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">Guardar Producto</button>
                        <button id="closeProductModal" type="button" class="mt-2 px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div id="viewQRModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full items-center justify-center">
        <div class="relative mx-auto p-5 border w-auto max-w-xs shadow-lg rounded-md bg-white">
            <h3 class="text-lg leading-6 font-medium text-gray-900 text-center mb-4">Código QR del Producto</h3>
            <canvas id="qrCanvas" class="mx-auto"></canvas>
            <p id="qrCodeText" class="text-center font-mono mt-2"></p>
            <button id="closeViewQRModal" type="button" class="mt-4 px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400">Cerrar</button>
        </div>
    </div>

    <div id="storeModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full items-center justify-center">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" id="storeModalTitle">Añadir Nueva Tienda</h3>
            <form id="storeForm" class="mt-4 space-y-4">
                <input type="hidden" id="storeId">
                <div>
                    <label for="storeName" class="block text-sm font-medium text-gray-700">Nombre de la Tienda:</label>
                    <input type="text" id="storeName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                <div class="items-center px-4 py-3">
                    <button id="saveStoreButton" type="submit" class="px-4 py-2 bg-purple-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-purple-600">Guardar Tienda</button>
                    <button id="closeStoreModal" type="button" class="mt-2 px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="recordSaleModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full items-center justify-center">
        <div class="relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <h3 class="text-lg leading-6 font-medium text-gray-900 text-center mb-4">Registrar Nueva Venta</h3>
            <form id="saleForm" class="space-y-4">
                <div>
                    <label for="saleStore" class="block text-sm font-medium text-gray-700">Seleccionar Tienda:</label>
                    <select id="saleStore" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        </select>
                </div>

                <div class="border p-3 rounded-md">
                    <h4 class="text-md font-medium mb-2">Añadir Producto a la Venta:</h4>
                    <div class="flex items-center space-x-2 mb-2">
                        <input type="text" id="saleSearchProduct" class="block w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="Buscar por nombre o escanear QR...">
                        <button type="button" id="scanProductQRSale" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-3 rounded-lg">
                            <i data-lucide="scan-line"></i>
                        </button>
                    </div>
                    <div id="saleQRScannerContainer" class="mb-2 hidden">
                         <div id="sale-qr-reader" class="w-full md:w-1/2 mx-auto"></div>
                         <button id="stopSaleQRScan" class="mt-2 bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg block mx-auto">Detener Escaneo</button>
                    </div>
                    <div id="saleProductSearchResults" class="product-search-results border rounded bg-white shadow"></div>
                </div>

                <div class="border p-3 rounded-md">
                    <h4 class="text-md font-medium mb-2">Productos en esta Venta:</h4>
                    <div id="saleItemsList" class="space-y-2 max-h-60 overflow-y-auto">
                        </div>
                    <p class="text-right font-bold mt-2">Total Venta: <span id="saleTotalAmount">0.00</span></p>
                </div>

                <div class="items-center px-4 py-3">
                    <button id="saveSaleButton" type="submit" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600">Confirmar Venta</button>
                    <button id="closeSaleModal" type="button" class="mt-2 px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmationModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full items-center justify-center">
        <div class="relative mx-auto p-5 border w-full max-w-sm shadow-lg rounded-md bg-white">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="confirmationTitle">Confirmar Acción</h3>
            <p id="confirmationMessage" class="mt-2 text-sm text-gray-600">¿Estás seguro?</p>
            <div class="mt-4 flex justify-end space-x-2">
                <button id="confirmActionButton" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md hover:bg-red-600">Confirmar</button>
                <button id="cancelActionButton" class="px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md hover:bg-gray-400">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white py-3 px-5 rounded-lg shadow-lg transition-opacity duration-300 opacity-0 z-50">
        <p id="toastMessage"></p>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, remove, update, child, push as firebasePush } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // Firebase configuration (will be provided by the environment)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        let fbApp;
        let fbAuth;
        let fbDb;
        let userId = null;

        // Database references
        let productsRef, storesRef, salesRef;

        // Local cache of data (primarily for quick filtering/searching and populating forms)
        let localProducts = {}; 
        let localStores = {};
        let localSales = {};
        
        let currentEditingProductId = null;
        let currentEditingStoreId = null;
        let inventoryQrScanner = null;
        let saleQrScanner = null;
        let currentSaleItems = []; 

        const loadingOverlay = document.getElementById('loadingOverlay');

        // --- Initialize Firebase and Auth ---
        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing!");
                showToast("Error crítico: Configuración de Firebase no encontrada.", "error");
                loadingOverlay.textContent = "Error: Configuración de Firebase no encontrada.";
                return;
            }

            try {
                fbApp = initializeApp(firebaseConfig);
                fbAuth = getAuth(fbApp);
                fbDb = getDatabase(fbApp);
                console.log("Firebase initialized.");
                document.getElementById('appIdDisplay').textContent = appId;

                // Set log level to debug for more detailed Firebase logs
                // firebase.setLogLevel('debug'); // For older SDK versions, not directly available in v9+ modular

                onAuthStateChanged(fbAuth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User is signed in with UID:", userId);
                        document.getElementById('userIdDisplay').textContent = userId;
                        setupDatabaseReferences();
                        loadInitialDataFromFirebase();
                    } else {
                        console.log("User is signed out. Attempting to sign in...");
                        await attemptSignIn();
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showToast("Error al inicializar Firebase: " + error.message, "error");
                loadingOverlay.textContent = "Error al conectar con Firebase.";
            }
        }

        async function attemptSignIn() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    console.log("Attempting sign in with custom token...");
                    await signInWithCustomToken(fbAuth, __initial_auth_token);
                } else {
                    console.log("Attempting anonymous sign in...");
                    await signInAnonymously(fbAuth);
                }
            } catch (error) {
                console.error("Error during sign-in:", error);
                showToast("Error de autenticación: " + error.message, "error");
                loadingOverlay.textContent = "Error de autenticación.";
                // If sign-in fails, we might not be able to proceed.
            }
        }

        function setupDatabaseReferences() {
            if (!userId) {
                console.error("User ID is not available. Cannot set up database references.");
                showToast("Error: Usuario no identificado. No se pueden cargar los datos.", "error");
                loadingOverlay.textContent = "Error: Usuario no identificado.";
                return;
            }
            const basePath = `artifacts/${appId}/users/${userId}`;
            productsRef = ref(fbDb, `${basePath}/products`);
            storesRef = ref(fbDb, `${basePath}/stores`);
            salesRef = ref(fbDb, `${basePath}/sales`);
            console.log("Database references set up for user:", userId);
        }
        
        // --- DOMContentLoaded to initialize ---
        document.addEventListener('DOMContentLoaded', async () => {
            loadingOverlay.style.display = 'flex'; // Show loading overlay
            await initializeFirebase(); // Initialize Firebase first

            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            } else {
                console.warn("Lucide icons no están disponibles al cargar la página.");
            }
            // Other initializations that don't depend on Firebase data yet
            setupEventListeners();
        });

        function setupEventListeners() {
            // Tab navigation
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabPanes = document.querySelectorAll('.tab-pane');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    const tab = button.getAttribute('data-tab');
                    tabPanes.forEach(pane => {
                        if (pane.id === `${tab}-content`) {
                            pane.classList.remove('hidden');
                            pane.classList.add('active');
                        } else {
                            pane.classList.remove('active');
                            pane.classList.add('hidden');
                        }
                    });
                    stopAllScanners(); 
                });
            });

            // Confirmation Modal
            confirmActionButton.addEventListener('click', () => {
                if (currentConfirmAction) currentConfirmAction();
                closeModal('confirmationModal');
                currentConfirmAction = null;
            });
            cancelActionButton.addEventListener('click', () => {
                closeModal('confirmationModal');
                currentConfirmAction = null;
            });

            // Store Management Modals & Form
            document.getElementById('openAddStoreModal').addEventListener('click', openAddStoreModalHandler);
            document.getElementById('closeStoreModal').addEventListener('click', () => closeModal('storeModal'));
            document.getElementById('storeForm').addEventListener('submit', saveStoreHandler);

            // Product Management Modals & Form
            document.getElementById('openAddProductModal').addEventListener('click', openAddProductModalHandler);
            document.getElementById('closeProductModal').addEventListener('click', () => closeModal('productModal'));
            document.getElementById('productForm').addEventListener('submit', saveProductHandler);
            document.getElementById('searchProductQR').addEventListener('input', () => renderProducts(localProducts));
            document.getElementById('closeViewQRModal').addEventListener('click', () => closeModal('viewQRModal'));


            // Sales Management Modals & Form
            document.getElementById('openRecordSaleModal').addEventListener('click', openRecordSaleModalHandler);
            document.getElementById('closeSaleModal').addEventListener('click', () => {
                closeModal('recordSaleModal');
                stopSaleQRScanner(); 
            });
            document.getElementById('saleForm').addEventListener('submit', saveSaleHandler);
            document.getElementById('saleSearchProduct').addEventListener('input', saleSearchProductHandler);
            
            // QR Scanners
            document.getElementById('scanProductQRInventory').addEventListener('click', startInventoryQRScanner);
            document.getElementById('stopInventoryQRScan').addEventListener('click', stopInventoryQRScanner);
            document.getElementById('scanProductQRSale').addEventListener('click', startSaleQRScanner);
            document.getElementById('stopSaleQRScan').addEventListener('click', stopSaleQRScanner);

            // Import/Export
            document.getElementById('exportInventory').addEventListener('click', exportInventoryHandler);
            document.getElementById('importInventory').addEventListener('click', importInventoryHandler);
        }
        
        // --- Toast Notifications ---
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.classList.remove('opacity-0', 'bg-red-500', 'bg-green-500', 'bg-blue-500', 'bg-yellow-500');
            
            if (type === 'error') toast.classList.add('bg-red-500');
            else if (type === 'info') toast.classList.add('bg-blue-500');
            else if (type === 'warning') toast.classList.add('bg-yellow-500');
            else toast.classList.add('bg-green-600');
            
            toast.classList.add('opacity-100');
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
            }, 3000);
        }
        
        // --- Modal Helper Functions ---
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.add('active');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.remove('active');
        }
        
        // --- Confirmation Modal ---
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmActionButton = document.getElementById('confirmActionButton');
        const cancelActionButton = document.getElementById('cancelActionButton');
        let currentConfirmAction = null;

        function showConfirmationModal(title, message, onConfirm) {
            document.getElementById('confirmationTitle').textContent = title;
            document.getElementById('confirmationMessage').textContent = message;
            currentConfirmAction = onConfirm;
            openModal('confirmationModal');
        }

        // --- Store Management ---
        const storeModal = document.getElementById('storeModal');
        const storeForm = document.getElementById('storeForm');
        const storeListEl = document.getElementById('storeList');
        const saleStoreSelect = document.getElementById('saleStore');

        function openAddStoreModalHandler() {
            storeForm.reset();
            currentEditingStoreId = null;
            document.getElementById('storeModalTitle').textContent = 'Añadir Nueva Tienda';
            openModal('storeModal');
        }

        async function saveStoreHandler(e) {
            e.preventDefault();
            if (!storesRef) { showToast("Error: Referencia a tiendas no configurada.", "error"); return; }

            const storeName = document.getElementById('storeName').value.trim();
            if (!storeName) {
                showToast("El nombre de la tienda es obligatorio.", "error");
                return;
            }

            // Check for duplicate store names (case-insensitive)
            const storesArray = Object.values(localStores);
            if (storesArray.some(s => s.name.toLowerCase() === storeName.toLowerCase() && s.id !== currentEditingStoreId)) {
                 showToast("Error: Ya existe una tienda con este nombre.", "error");
                 return;
            }

            try {
                if (currentEditingStoreId) { // Editing
                    await set(ref(fbDb, `${storesRef.key}/${currentEditingStoreId}`), { name: storeName, id: currentEditingStoreId });
                    showToast("Tienda actualizada con éxito.");
                } else { // Adding new
                    const newStoreId = crypto.randomUUID();
                    await set(ref(fbDb, `${storesRef.key}/${newStoreId}`), { name: storeName, id: newStoreId });
                    showToast("Tienda añadida con éxito.");
                }
                closeModal('storeModal');
                // Real-time listener will update the list (renderStores)
            } catch (error) {
                console.error("Error guardando tienda:", error);
                showToast("Error al guardar la tienda: " + error.message, "error");
            }
        }
        
        function renderStores(storesData) {
            localStores = storesData || {}; // Update local cache
            storeListEl.innerHTML = '';
            saleStoreSelect.innerHTML = '<option value="">Seleccione una tienda</option>';
            
            const storesArray = Object.values(localStores);

            if (storesArray.length === 0) {
                storeListEl.innerHTML = '<tr><td colspan="3" class="text-center py-4">No hay tiendas registradas.</td></tr>';
            } else {
                storesArray.forEach(store => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${store.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${store.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button data-id="${store.id}" class="edit-store-btn text-indigo-600 hover:text-indigo-900 mr-2" title="Editar"><i data-lucide="edit" class="inline-block"></i></button>
                            <button data-id="${store.id}" class="delete-store-btn text-red-600 hover:text-red-900" title="Eliminar"><i data-lucide="trash-2" class="inline-block"></i></button>
                        </td>
                    `;
                    storeListEl.appendChild(tr);

                    const option = document.createElement('option');
                    option.value = store.id;
                    option.textContent = store.name;
                    saleStoreSelect.appendChild(option);
                });
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();

            document.querySelectorAll('.edit-store-btn').forEach(button => {
                button.addEventListener('click', (e) => loadStoreForEdit(e.currentTarget.getAttribute('data-id')));
            });
            document.querySelectorAll('.delete-store-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const storeIdToDelete = e.currentTarget.getAttribute('data-id');
                    const storeName = localStores[storeIdToDelete]?.name || storeIdToDelete;
                    showConfirmationModal('Eliminar Tienda', `¿Estás seguro de que quieres eliminar la tienda "${storeName}"? Esta acción no se puede deshacer.`, () => deleteStore(storeIdToDelete));
                });
            });
        }

        function loadStoreForEdit(storeId) {
            const store = localStores[storeId];
            if (store) {
                currentEditingStoreId = store.id;
                document.getElementById('storeModalTitle').textContent = 'Editar Tienda';
                document.getElementById('storeId').value = store.id; // Hidden field, not strictly necessary if using currentEditingStoreId
                document.getElementById('storeName').value = store.name;
                openModal('storeModal');
            } else {
                showToast("Tienda no encontrada.", "error");
            }
        }

        async function deleteStore(storeId) {
            if (!storesRef) { showToast("Error: Referencia a tiendas no configurada.", "error"); return; }
            
            // Check if the store is used in any sales
            const salesArray = Object.values(localSales);
            const isStoreUsedInSales = salesArray.some(sale => sale.storeId === storeId);
            if (isStoreUsedInSales) {
                showToast("No se puede eliminar la tienda porque tiene ventas asociadas.", "error");
                return;
            }

            try {
                await remove(ref(fbDb, `${storesRef.key}/${storeId}`));
                showToast("Tienda eliminada con éxito.");
                // Real-time listener will update the list
            } catch (error) {
                console.error("Error eliminando tienda:", error);
                showToast("Error al eliminar la tienda: " + error.message, "error");
            }
        }

        // --- Product Management ---
        const productModal = document.getElementById('productModal');
        const productForm = document.getElementById('productForm');
        const productListElement = document.getElementById('productList');
        const searchProductQRInput = document.getElementById('searchProductQR');

        function openAddProductModalHandler() {
            productForm.reset();
            currentEditingProductId = null;
            document.getElementById('productModalTitle').textContent = 'Añadir Producto';
            document.getElementById('productQR').disabled = false;
            document.getElementById('productId').value = '';
            openModal('productModal');
        }

        async function saveProductHandler(e) {
            e.preventDefault();
            if (!productsRef) { showToast("Error: Referencia a productos no configurada.", "error"); return; }

            let productQR = document.getElementById('productQR').value.trim();
            const productName = document.getElementById('productName').value.trim();
            const productQuantity = parseInt(document.getElementById('productQuantity').value);
            const productCostPrice = parseFloat(document.getElementById('productCostPrice').value);
            const productSalePrice = parseFloat(document.getElementById('productSalePrice').value);
            const productMinStock = parseInt(document.getElementById('productMinStock').value) || 0;

            if (!productName || isNaN(productQuantity) || isNaN(productCostPrice) || isNaN(productSalePrice)) {
                showToast("Por favor, completa todos los campos obligatorios correctamente.", "error");
                return;
            }
            if (productCostPrice > productSalePrice) {
                showToast("El precio de costo no puede ser mayor al precio de venta.", "error");
                 return; 
            }

            const productData = {
                name: productName,
                quantity: productQuantity,
                costPrice: productCostPrice,
                salePrice: productSalePrice,
                minStock: productMinStock,
            };
            
            try {
                if (currentEditingProductId) { // Editing
                    productData.id = productQR || currentEditingProductId; // Use new QR if provided, else old one
                    // Check if new QR ID (if changed) conflicts with another existing product
                    if (productQR && productQR !== currentEditingProductId && localProducts[productQR]) {
                         showToast("Error: El nuevo Código QR/ID ya existe para otro producto.", "error");
                         return;
                    }
                    // If QR ID changed, we need to remove the old one and set the new one
                    if (productQR && productQR !== currentEditingProductId) {
                        await remove(ref(fbDb, `${productsRef.key}/${currentEditingProductId}`)); // Remove old entry
                        await set(ref(fbDb, `${productsRef.key}/${productQR}`), productData); // Add as new entry with new ID
                    } else {
                        productData.id = currentEditingProductId; // Ensure ID is the original one
                        await update(ref(fbDb, `${productsRef.key}/${currentEditingProductId}`), productData);
                    }
                    showToast("Producto actualizado con éxito.");

                } else { // Adding new
                    if (!productQR) productQR = crypto.randomUUID();
                    else if (localProducts[productQR]) { // Check if user-provided QR exists
                        showToast("Error: Ya existe un producto con este Código QR/ID.", "error");
                        return;
                    }
                    productData.id = productQR;
                    await set(ref(fbDb, `${productsRef.key}/${productQR}`), productData);
                    showToast("Producto añadido con éxito.");
                }
                closeModal('productModal');
                productForm.reset();
                // Real-time listener will update the list
            } catch (error) {
                console.error("Error guardando producto:", error);
                showToast("Error al guardar el producto: " + error.message, "error");
            }
        }
        
        function getStockStatus(quantity, minStock) {
            if (quantity <= 0) return { text: "Agotado", class: "out-of-stock" };
            if (quantity <= minStock) return { text: "Stock Bajo", class: "low-stock" };
            return { text: "En Stock", class: "in-stock" };
        }

        function renderProducts(productsData) {
            localProducts = productsData || {}; // Update local cache
            productListElement.innerHTML = '';
            
            const searchTerm = searchProductQRInput.value.toLowerCase().trim();
            const productsArray = Object.values(localProducts).filter(product => 
                product.id.toLowerCase().includes(searchTerm) || 
                product.name.toLowerCase().includes(searchTerm)
            );

            if (productsArray.length === 0 && Object.keys(localProducts).length === 0) {
                 productListElement.innerHTML = '<tr><td colspan="8" class="text-center py-4">No hay productos en el inventario.</td></tr>';
            } else if (productsArray.length === 0 && searchTerm) {
                 productListElement.innerHTML = `<tr><td colspan="8" class="text-center py-4">No se encontraron productos para "${searchTerm}".</td></tr>`;
            }
            else {
                productsArray.forEach(product => {
                    const stockStatus = getStockStatus(product.quantity, product.minStock);
                    const tr = document.createElement('tr');
                    tr.classList.add(stockStatus.class.split(' ')[0]);

                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <canvas class="product-qr-canvas inline-block" data-qr="${product.id}" width="40" height="40"></canvas>
                            <span class="text-xs block">${product.id}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">${product.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${product.quantity}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${product.costPrice.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${product.salePrice.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${product.minStock}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${stockStatus.class}">${stockStatus.text}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button data-id="${product.id}" class="view-qr-btn text-blue-600 hover:text-blue-900 mr-2" title="Ver QR"><i data-lucide="qr-code" class="inline-block"></i></button>
                            <button data-id="${product.id}" class="edit-product-btn text-indigo-600 hover:text-indigo-900 mr-2" title="Editar"><i data-lucide="edit" class="inline-block"></i></button>
                            <button data-id="${product.id}" class="delete-product-btn text-red-600 hover:text-red-900" title="Eliminar"><i data-lucide="trash-2" class="inline-block"></i></button>
                        </td>
                    `;
                    productListElement.appendChild(tr);

                    const canvas = tr.querySelector('.product-qr-canvas');
                    if (canvas && typeof QRious !== 'undefined') {
                        new QRious({ element: canvas, value: product.id, size: 40, level: 'H' });
                    }
                });
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
            
            document.querySelectorAll('.edit-product-btn').forEach(button => {
                button.addEventListener('click', (e) => loadProductForEdit(e.currentTarget.getAttribute('data-id')));
            });
            document.querySelectorAll('.delete-product-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                     const productIdToDelete = e.currentTarget.getAttribute('data-id');
                     const productName = localProducts[productIdToDelete]?.name || productIdToDelete;
                     showConfirmationModal('Eliminar Producto', `¿Estás seguro de que quieres eliminar el producto "${productName}"? Esta acción no se puede deshacer.`, () => deleteProduct(productIdToDelete));
                });
            });
            document.querySelectorAll('.view-qr-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const qrValue = e.currentTarget.getAttribute('data-id');
                    const qrCanvas = document.getElementById('qrCanvas');
                    document.getElementById('qrCodeText').textContent = qrValue;
                    if (typeof QRious !== 'undefined') {
                         new QRious({ element: qrCanvas, value: qrValue, size: 200, level: 'H' });
                    }
                    openModal('viewQRModal');
                });
            });
            calculateFinancials();
        }

        function loadProductForEdit(productId) {
            const product = localProducts[productId];
            if (product) {
                currentEditingProductId = product.id;
                document.getElementById('productModalTitle').textContent = 'Editar Producto';
                document.getElementById('productId').value = product.id;
                document.getElementById('productQR').value = product.id; 
                document.getElementById('productQR').disabled = false; // Allow editing QR
                document.getElementById('productName').value = product.name;
                document.getElementById('productQuantity').value = product.quantity;
                document.getElementById('productCostPrice').value = product.costPrice;
                document.getElementById('productSalePrice').value = product.salePrice;
                document.getElementById('productMinStock').value = product.minStock;
                openModal('productModal');
            } else {
                showToast("Producto no encontrado.", "error");
            }
        }

        async function deleteProduct(productId) {
            if (!productsRef) { showToast("Error: Referencia a productos no configurada.", "error"); return; }

            const salesArray = Object.values(localSales);
            const isProductInSale = salesArray.some(sale => sale.items.some(item => item.productId === productId));
            if (isProductInSale) {
                showToast("No se puede eliminar el producto porque está incluido en ventas registradas.", "error");
                return;
            }
            try {
                await remove(ref(fbDb, `${productsRef.key}/${productId}`));
                showToast("Producto eliminado con éxito.");
                // Real-time listener will update
            } catch (error) {
                console.error("Error eliminando producto:", error);
                showToast("Error al eliminar el producto: " + error.message, "error");
            }
        }
        
        // --- Sales Management ---
        const recordSaleModal = document.getElementById('recordSaleModal');
        const saleForm = document.getElementById('saleForm');
        const salesHistoryTable = document.getElementById('salesHistory');
        const saleSearchProductInput = document.getElementById('saleSearchProduct');
        const saleProductSearchResultsDiv = document.getElementById('saleProductSearchResults');
        const saleItemsListDiv = document.getElementById('saleItemsList');
        const saleTotalAmountSpan = document.getElementById('saleTotalAmount');

        function openRecordSaleModalHandler() {
            saleForm.reset();
            currentSaleItems = [];
            updateSaleItemsList();
            updateSaleTotal();
            saleProductSearchResultsDiv.innerHTML = ''; 
            saleSearchProductInput.value = ''; 
            
            if (Object.keys(localStores).length === 0) {
                showToast("No hay tiendas registradas. Por favor, añada una tienda primero.", "warning");
                return;
            }
            // renderStores already populates saleStoreSelect, called by onValue
            openModal('recordSaleModal');
        }
        
        function saleSearchProductHandler(e) {
            const searchTerm = e.target.value.trim().toLowerCase();
            if (searchTerm.length < 1) {
                saleProductSearchResultsDiv.innerHTML = '';
                saleProductSearchResultsDiv.classList.add('hidden');
                return;
            }
            
            const productsArray = Object.values(localProducts);
            const results = productsArray.filter(product => 
                product.quantity > 0 &&
                (product.name.toLowerCase().includes(searchTerm) || product.id.toLowerCase().includes(searchTerm))
            );
            renderSaleProductSearchResults(results);
        }


        function renderSaleProductSearchResults(products) {
            saleProductSearchResultsDiv.innerHTML = '';
            if (products.length === 0) {
                saleProductSearchResultsDiv.innerHTML = '<p class="p-2 text-gray-500">No se encontraron productos disponibles.</p>';
            } else {
                products.forEach(product => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'p-2 border-b cursor-pointer product-search-item';
                    itemDiv.textContent = `${product.name} (Stock: ${product.quantity}, Precio: ${product.salePrice.toFixed(2)}) - ID: ${product.id}`;
                    itemDiv.addEventListener('click', () => addProductToSale(product));
                    saleProductSearchResultsDiv.appendChild(itemDiv);
                });
            }
            saleProductSearchResultsDiv.classList.remove('hidden');
        }
        
        function addProductToSale(product) {
            if (product.quantity <= 0) {
                showToast(`"${product.name}" está agotado.`, "error");
                return;
            }

            const existingItem = currentSaleItems.find(item => item.productId === product.id);
            if (existingItem) {
                const productInStock = localProducts[product.id]; // Get current stock from local cache
                if (productInStock && existingItem.quantity < productInStock.quantity) {
                    existingItem.quantity++;
                } else {
                    showToast(`No hay más stock disponible para "${product.name}".`, "warning");
                }
            } else {
                currentSaleItems.push({
                    productId: product.id,
                    productName: product.name,
                    quantity: 1,
                    unitPrice: product.salePrice,
                    costPrice: product.costPrice 
                });
            }
            updateSaleItemsList();
            updateSaleTotal();
            saleSearchProductInput.value = ''; 
            saleProductSearchResultsDiv.innerHTML = ''; 
            saleProductSearchResultsDiv.classList.add('hidden');
        }

        function updateSaleItemsList() {
            saleItemsListDiv.innerHTML = '';
            if (currentSaleItems.length === 0) {
                saleItemsListDiv.innerHTML = '<p class="text-gray-500">Aún no hay productos en esta venta.</p>';
            } else {
                currentSaleItems.forEach((item, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex justify-between items-center p-2 border rounded';
                    itemDiv.innerHTML = `
                        <div>
                            <p class="font-medium">${item.productName}</p>
                            <p class="text-sm text-gray-600">Precio: ${item.unitPrice.toFixed(2)} c/u</p>
                        </div>
                        <div class="flex items-center">
                            <button type="button" data-index="${index}" class="decrease-qty-btn bg-gray-200 px-2 py-1 rounded-l hover:bg-gray-300">-</button>
                            <span class="px-3">${item.quantity}</span>
                            <button type="button" data-index="${index}" class="increase-qty-btn bg-gray-200 px-2 py-1 rounded-r hover:bg-gray-300">+</button>
                            <button type="button" data-index="${index}" class="remove-item-btn text-red-500 hover:text-red-700 ml-3"><i data-lucide="trash-2" class="inline-block"></i></button>
                        </div>
                    `;
                    saleItemsListDiv.appendChild(itemDiv);
                });
            }
            if(typeof lucide !== 'undefined') lucide.createIcons();

            document.querySelectorAll('.decrease-qty-btn').forEach(btn => btn.addEventListener('click', (e) => updateSaleItemQuantity(parseInt(e.currentTarget.dataset.index), -1)));
            document.querySelectorAll('.increase-qty-btn').forEach(btn => btn.addEventListener('click', (e) => updateSaleItemQuantity(parseInt(e.currentTarget.dataset.index), 1)));
            document.querySelectorAll('.remove-item-btn').forEach(btn => btn.addEventListener('click', (e) => removeSaleItem(parseInt(e.currentTarget.dataset.index))));
        }
        
        function updateSaleItemQuantity(index, change) {
            const item = currentSaleItems[index];
            if (!item) return;

            const newQuantity = item.quantity + change;

            if (newQuantity <= 0) { 
                removeSaleItem(index);
                return;
            }
            
            const productInStock = localProducts[item.productId];
            if (productInStock && newQuantity > productInStock.quantity) {
                showToast(`Stock insuficiente para "${item.productName}". Disponible: ${productInStock.quantity}.`, "warning");
                return; 
            }
            item.quantity = newQuantity;
            
            updateSaleItemsList();
            updateSaleTotal();
        }

        function removeSaleItem(index) {
            currentSaleItems.splice(index, 1);
            updateSaleItemsList();
            updateSaleTotal();
        }

        function updateSaleTotal() {
            const total = currentSaleItems.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0);
            saleTotalAmountSpan.textContent = total.toFixed(2);
        }

        async function saveSaleHandler(e) {
            e.preventDefault();
            if (!salesRef || !productsRef) { showToast("Error: Referencias a base de datos no configuradas.", "error"); return; }

            const saleStoreElement = document.getElementById('saleStore');
            const storeId = saleStoreElement.value;
            const storeName = saleStoreElement.options[saleStoreElement.selectedIndex]?.text || "Tienda Desconocida";

            if (!storeId) {
                showToast("Por favor, seleccione una tienda.", "error");
                return;
            }
            if (currentSaleItems.length === 0) {
                showToast("Añada al menos un producto a la venta.", "error");
                return;
            }

            const saleItemsForRecord = JSON.parse(JSON.stringify(currentSaleItems));
            const saleData = {
                id: crypto.randomUUID(),
                storeId: storeId,
                storeName: storeName,
                items: saleItemsForRecord.map(item => ({ 
                    productId: item.productId,
                    productName: item.productName,
                    quantity: item.quantity,
                    unitPrice: item.unitPrice,
                    totalItemPrice: item.quantity * item.unitPrice,
                    itemCost: item.costPrice,
                    itemProfit: (item.unitPrice - item.costPrice) * item.quantity 
                })),
                totalAmount: parseFloat(saleTotalAmountSpan.textContent),
                totalProfit: saleItemsForRecord.reduce((sum, item) => sum + (item.unitPrice - item.costPrice) * item.quantity, 0),
                date: new Date().toISOString()
            };

            // Transaction-like update for product quantities
            const updates = {};
            let stockSufficient = true;

            for (const item of saleData.items) {
                const productSnapshot = await get(child(productsRef, item.productId));
                if (productSnapshot.exists()) {
                    const productDataFirebase = productSnapshot.val();
                    if (productDataFirebase.quantity >= item.quantity) {
                        updates[`${productsRef.key}/${item.productId}/quantity`] = productDataFirebase.quantity - item.quantity;
                    } else {
                        showToast(`Stock insuficiente para ${item.productName} (en base de datos). Venta cancelada.`, "error");
                        stockSufficient = false;
                        break;
                    }
                } else {
                    showToast(`Producto ${item.productName} no encontrado en base de datos. Venta cancelada.`, "error");
                    stockSufficient = false;
                    break;
                }
            }

            if (!stockSufficient) {
                renderProducts(localProducts); // Re-render with current local cache if sale failed
                return;
            }

            try {
                // Add sale record
                updates[`${salesRef.key}/${saleData.id}`] = saleData;
                await update(ref(fbDb), updates); // Perform all updates (sale + product quantities)

                showToast("Venta registrada y stock actualizado con éxito.");
                closeModal('recordSaleModal');
                currentSaleItems = []; // Clear items for next sale
                // Real-time listeners will update products and sales history
            } catch (error) {
                console.error("Error registrando venta:", error);
                showToast("Error al registrar la venta: " + error.message, "error");
            }
        }
        
        function renderSalesHistory(salesData) {
            localSales = salesData || {}; // Update local cache
            salesHistoryTable.innerHTML = '';
            const salesArray = Object.values(localSales).sort((a, b) => new Date(b.date) - new Date(a.date));

             if (salesArray.length === 0) {
                salesHistoryTable.innerHTML = '<tr><td colspan="5" class="text-center py-4">No hay ventas registradas.</td></tr>';
            } else {
                salesArray.forEach(sale => {
                    const tr = document.createElement('tr');
                    const itemsSummary = sale.items.map(item => `${item.productName} (x${item.quantity})`).join(', ');
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${new Date(sale.date).toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${sale.storeName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${itemsSummary}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${sale.totalAmount.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${sale.totalProfit.toFixed(2)}</td>
                    `;
                    salesHistoryTable.appendChild(tr);
                });
            }
            calculateFinancials();
        }

        // --- QR Code Scanning ---
        function onScanSuccess(decodedText, context) {
            console.log(`Code matched = ${decodedText}`);
            if (context === 'inventory') {
                searchProductQRInput.value = decodedText;
                renderProducts(localProducts); // Filter based on new input
                stopInventoryQRScanner();
            } else if (context === 'sale') {
                saleSearchProductInput.value = decodedText;
                const event = new Event('input', { bubbles: true, cancelable: true });
                saleSearchProductInput.dispatchEvent(event);
                stopSaleQRScanner();
            }
        }

        function onScanFailure(error) { /* console.warn(`Code scan error = ${error}`); */ }

        function startInventoryQRScanner() {
            const qrReaderDiv = document.getElementById('inventory-qr-reader');
            const container = document.getElementById('inventoryQRScannerContainer');
            if (!Html5Qrcode) { showToast("Librería de escaneo QR no cargada.", "error"); return; }
            
            container.classList.remove('hidden');
            qrReaderDiv.innerHTML = ''; 

            if (!inventoryQrScanner) inventoryQrScanner = new Html5Qrcode("inventory-qr-reader");
           
            inventoryQrScanner.start(
                { facingMode: "environment" }, 
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText, decodedResult) => onScanSuccess(decodedText, 'inventory'),
                onScanFailure
            ).catch(err => {
                console.error("Error iniciando escáner de inventario:", err);
                showToast("Error al iniciar escáner QR (inventario): " + (err.message || err), "error");
                container.classList.add('hidden');
            });
        }
        
        function stopInventoryQRScanner() {
            const container = document.getElementById('inventoryQRScannerContainer');
            if (inventoryQrScanner && inventoryQrScanner.isScanning) { 
                inventoryQrScanner.stop().catch(err => console.warn("Advertencia al detener escáner de inventario:", err))
                                  .finally(() => container.classList.add('hidden'));
            } else {
                 container.classList.add('hidden');
            }
        }

        function startSaleQRScanner() {
            const qrReaderDiv = document.getElementById('sale-qr-reader');
            const container = document.getElementById('saleQRScannerContainer');
            if (!Html5Qrcode) { showToast("Librería de escaneo QR no cargada.", "error"); return; }

            container.classList.remove('hidden');
            qrReaderDiv.innerHTML = '';

            if (!saleQrScanner) saleQrScanner = new Html5Qrcode("sale-qr-reader");
            
            saleQrScanner.start(
                { facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } },
                 (decodedText, decodedResult) => onScanSuccess(decodedText, 'sale'),
                 onScanFailure
            ).catch(err => {
                console.error("Error iniciando escáner de ventas:", err);
                showToast("Error al iniciar escáner QR (ventas): " + (err.message || err), "error");
                container.classList.add('hidden');
            });
        }

        function stopSaleQRScanner() {
            const container = document.getElementById('saleQRScannerContainer');
            if (saleQrScanner && saleQrScanner.isScanning) { 
                saleQrScanner.stop().catch(err => console.warn("Advertencia al detener escáner de ventas:", err))
                               .finally(() => container.classList.add('hidden'));
            } else {
                container.classList.add('hidden');
            }
        }
        
        function stopAllScanners() {
            stopInventoryQRScanner();
            stopSaleQRScanner();
        }

        // --- Financial Reports ---
        function calculateFinancials() {
            const productsArray = Object.values(localProducts);
            const totalInventoryValue = productsArray.reduce((sum, product) => sum + (product.quantity * product.costPrice), 0);
            document.getElementById('totalInventoryValue').textContent = `$${totalInventoryValue.toFixed(2)}`;

            const salesArray = Object.values(localSales);
            const totalGrossProfit = salesArray.reduce((sum, sale) => sum + sale.totalProfit, 0);
            document.getElementById('totalGrossProfit').textContent = `$${totalGrossProfit.toFixed(2)}`;
        }

        // --- Import/Export Excel ---
        function exportInventoryHandler() {
            const productsArray = Object.values(localProducts);
            if (productsArray.length === 0) {
                showToast("No hay productos para exportar.", "info");
                return;
            }
            const dataToExport = productsArray.map(p => ({
                'QR_ID': p.id, 'Nombre': p.name, 'Cantidad': p.quantity,
                'PrecioCosto': p.costPrice, 'PrecioVenta': p.salePrice, 'StockMinimo': p.minStock
            }));
            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Inventario");
            XLSX.writeFile(workbook, `inventario_firebase_${userId.substring(0,6)}.xlsx`);
            showToast("Inventario exportado con éxito.", "success");
        }

        async function importInventoryHandler() {
            if (!productsRef) { showToast("Error: Referencia a productos no configurada.", "error"); return; }
            const fileInput = document.getElementById('importFile');
            if (fileInput.files.length === 0) {
                showToast("Por favor, selecciona un archivo Excel para importar.", "warning");
                return;
            }
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (jsonData.length === 0) {
                        showToast("El archivo Excel está vacío o no tiene datos.", "warning"); return;
                    }

                    let productsAdded = 0, productsUpdated = 0, productsSkipped = 0;
                    const updates = {}; // For batching Firebase updates

                    for (const row of jsonData) {
                        let qrId = row['QR_ID'] ? String(row['QR_ID']).trim() : null;
                        const name = String(row['Nombre'] || '').trim();
                        const quantity = parseInt(row['Cantidad']);
                        const costPrice = parseFloat(row['PrecioCosto']);
                        const salePrice = parseFloat(row['PrecioVenta']);
                        const minStock = parseInt(row['StockMinimo']) || 0;

                        if (!name || isNaN(quantity) || isNaN(costPrice) || isNaN(salePrice)) {
                            console.warn(`Fila ignorada (datos incompletos/incorrectos): ${JSON.stringify(row)}`);
                            productsSkipped++; continue;
                        }
                         if (costPrice > salePrice) {
                            console.warn(`Fila ignorada para "${name}": Precio costo > Precio venta.`);
                            showToast(`Error en producto "${name}" del archivo: Precio costo > Precio venta. Fila ignorada.`, "warning");
                            productsSkipped++; continue;
                        }

                        const productData = { name, quantity, costPrice, salePrice, minStock };
                        
                        let existingProduct = null;
                        if (qrId && localProducts[qrId]) { // Found by QR ID
                            existingProduct = localProducts[qrId];
                        } else { // Try to find by name (case-insensitive) if QR not provided or not found
                            const productsArray = Object.values(localProducts);
                            existingProduct = productsArray.find(p => p.name.toLowerCase() === name.toLowerCase());
                            if (existingProduct && !qrId) qrId = existingProduct.id; // Use existing ID if found by name
                        }

                        if (existingProduct) { // Update
                            productData.id = existingProduct.id; // Ensure ID is the original one
                            // If a new QR was provided in Excel and it's different AND it conflicts with another product
                            if (qrId && qrId !== existingProduct.id && localProducts[qrId]) {
                                showToast(`Conflicto de QR ID "${qrId}" para "${name}". Se mantuvo el ID original "${existingProduct.id}".`, "warning");
                            } else if (qrId && qrId !== existingProduct.id) { // QR ID changed and no conflict
                                // This case is tricky: implies deleting old ID and creating new.
                                // For simplicity, we'll update the existing record, if QR_ID field is meant to be mutable.
                                // If QR_ID is immutable, this should be an error or handled differently.
                                // Assuming QR_ID can be changed here if unique.
                                updates[`${productsRef.key}/${existingProduct.id}`] = null; // Mark for deletion
                                productData.id = qrId; // Set new ID
                                updates[`${productsRef.key}/${qrId}`] = productData; // Add with new ID
                            } else {
                                updates[`${productsRef.key}/${existingProduct.id}`] = productData;
                            }
                            productsUpdated++;
                        } else { // Add new
                            productData.id = qrId || crypto.randomUUID();
                            if (localProducts[productData.id]) { // Generated/Provided ID conflicts
                                showToast(`QR ID "${productData.id}" para nuevo producto "${name}" ya existe. Generando uno nuevo.`, "warning");
                                productData.id = crypto.randomUUID();
                            }
                            updates[`${productsRef.key}/${productData.id}`] = productData;
                            productsAdded++;
                        }
                    }
                    
                    if (Object.keys(updates).length > 0) {
                        await update(ref(fbDb), updates); // Batch update/set/remove
                        showToast(`${productsAdded} prod. añadidos, ${productsUpdated} actualizados. ${productsSkipped > 0 ? productsSkipped + ' filas ignoradas.' : ''}`, "success");
                    } else if (productsSkipped > 0 && jsonData.length === productsSkipped) {
                         showToast("Todos los productos del archivo fueron ignorados.", "warning");
                    } else {
                        showToast("No se procesaron nuevos productos del archivo.", "info");
                    }
                    fileInput.value = '';
                } catch (error) {
                    console.error("Error importando inventario:", error);
                    showToast("Error al importar inventario: " + error.message, "error");
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // --- Initial Data Load from Firebase ---
        function loadInitialDataFromFirebase() {
            if (!userId || !productsRef || !storesRef || !salesRef) {
                console.log("Firebase not ready or user not authenticated for initial load.");
                loadingOverlay.textContent = "Esperando conexión con Firebase...";
                // Don't hide loading overlay yet, wait for auth and refs.
                return;
            }
            console.log("Starting initial data load from Firebase...");

            let productsLoaded = false;
            let storesLoaded = false;
            let salesLoaded = false;

            const checkAllDataLoaded = () => {
                if (productsLoaded && storesLoaded && salesLoaded) {
                    loadingOverlay.style.display = 'none'; // Hide loading overlay
                    console.log("All initial data loaded.");
                    showToast("Datos cargados desde Firebase.", "info");
                }
            };

            onValue(productsRef, (snapshot) => {
                const data = snapshot.val();
                renderProducts(data); // data will be null if no products, or an object
                productsLoaded = true;
                checkAllDataLoaded();
                console.log("Products loaded/updated from Firebase:", data);
            }, (error) => {
                console.error("Error cargando productos:", error);
                showToast("Error al cargar productos: " + error.message, "error");
                productsLoaded = true; checkAllDataLoaded(); // Still mark as "loaded" to potentially hide overlay
            });

            onValue(storesRef, (snapshot) => {
                const data = snapshot.val();
                renderStores(data);
                storesLoaded = true;
                checkAllDataLoaded();
                console.log("Stores loaded/updated from Firebase:", data);
            }, (error) => {
                console.error("Error cargando tiendas:", error);
                showToast("Error al cargar tiendas: " + error.message, "error");
                storesLoaded = true; checkAllDataLoaded();
            });

            onValue(salesRef, (snapshot) => {
                const data = snapshot.val();
                renderSalesHistory(data);
                salesLoaded = true;
                checkAllDataLoaded();
                console.log("Sales loaded/updated from Firebase:", data);
            }, (error) => {
                console.error("Error cargando historial de ventas:", error);
                showToast("Error al cargar ventas: " + error.message, "error");
                salesLoaded = true; checkAllDataLoaded();
            });
        }

    </script>
</body>
</html>
